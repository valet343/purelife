<modification>
    <name>DEV-OPENCART.COM - Видео в товаре (DEVCART PRO)</name>
    <version>1</version>
    <link>https://dev-opencart.com</link>
    <author>DEV-OPENCART.COM</author>
    <code>dev_opencart_com_product_video</code>

    <!-- Back -->

        <!-- Переводы -->
        <file path="admin/language/en-gb/catalog/product.php">
            <operation>
                <search><![CDATA[// Text]]></search>
                <add position="after"><![CDATA[
                $_['tab_video'] = 'Video';
                $_['entry_video'] = 'Link to video from Youtube (ex: https://www.youtube.com/watch?v=cVtLIf-Cg-4)';
                $_['entry_additional_video'] = 'Videos';
                ]]></add>
            </operation>
        </file>
        <file path="admin/language/ru-ru/catalog/product.php">
            <operation>
                <search><![CDATA[// Text]]></search>
                <add position="after"><![CDATA[
                $_['tab_video'] = 'Видео';
                $_['entry_video'] = 'Ссылка на видео с Youtube (например: https://www.youtube.com/watch?v=cVtLIf-Cg-4)';
                $_['entry_additional_video'] = 'Видео';
                ]]></add>
            </operation>
        </file>
        <file path="admin/language/uk-ua/catalog/product.php">
            <operation>
                <search><![CDATA[// Text]]></search>
                <add position="after"><![CDATA[
                $_['tab_video'] = 'Відео';
                $_['entry_video'] = 'ID видео (наприклад: h0EtLWfG644)';
                $_['entry_additional_video'] = 'Відео';
                ]]></add>
            </operation>
        </file>

        <!-- Контроллер -->
        <file path="admin/controller/catalog/product.php">
            <operation>
                <search><![CDATA[$this->response->setOutput($this->load->view('catalog/product_form', $data));]]></search>
                <add position="before"><![CDATA[
                $data['product_video_status'] = $this->config->get('theme_' . $this->config->get('config_theme') . '_product_video_status');
                ]]></add>
            </operation>
            <operation>
                <search><![CDATA[// Downloads]]></search>
                <add position="before"><![CDATA[
                // Videos
                if (isset($this->request->post['product_video'])) {
                    $product_videos = $this->request->post['product_video'];
                } elseif (isset($this->request->get['product_id'])) {
                    $product_videos = $this->model_catalog_product->getProductVideos($this->request->get['product_id']);
                } else {
                    $product_videos = array();
                }

                $data['product_videos'] = array();

                foreach ($product_videos as $product_video) {

                    $data['product_videos'][] = array(
                        'video' => $product_video['video'],
                        'sort_order' => $product_video['sort_order']
                    );
                }
                ]]></add>
            </operation>
        </file>

        <!-- Модель -->
        <file path="admin/model/catalog/product.php">
            <operation>
                <search index="0"><![CDATA[if (isset($data['product_image'])) {]]></search>
                <add position="before"><![CDATA[
                if (isset($data['product_video'])) {
                    foreach ($data['product_video'] as $product_video) {
                        $this->db->query("INSERT INTO " . DB_PREFIX . "product_video SET product_id = '" . (int)$product_id . "', video = '" . $this->db->escape($product_video['video']) . "', sort_order = '" . (int)$product_video['sort_order'] . "'");
                    }
                }
                ]]></add>
            </operation>
            <operation>
                <search index="0"><![CDATA[$this->db->query("DELETE FROM " . DB_PREFIX . "product_image WHERE product_id = '" . (int)$product_id . "'");]]></search>
                <add position="before"><![CDATA[
                $this->db->query("DELETE FROM " . DB_PREFIX . "product_video WHERE product_id = '" . (int)$product_id . "'");

                if (isset($data['product_video'])) {
                    foreach ($data['product_video'] as $product_video) {
                        $this->db->query("INSERT INTO " . DB_PREFIX . "product_video SET product_id = '" . (int)$product_id . "', video = '" . $this->db->escape($product_video['video']) . "', sort_order = '" . (int)$product_video['sort_order'] . "'");
                    }
                }
                ]]></add>
            </operation>
            <operation>
                <search index="0"><![CDATA[$data['product_image'] = $this->getProductImages($product_id);]]></search>
                <add position="before"><![CDATA[
                $data['product_video'] = $this->getProductVideos($product_id);
                ]]></add>
            </operation>
            <operation>
                <search index="1"><![CDATA[$this->db->query("DELETE FROM " . DB_PREFIX . "product_image WHERE product_id = '" . (int)$product_id . "'");]]></search>
                <add position="before"><![CDATA[
                $this->db->query("DELETE FROM " . DB_PREFIX . "product_video WHERE product_id = '" . (int)$product_id . "'");
                ]]></add>
            </operation>
            <operation>
                <search index="2"><![CDATA[$this->db->query("DELETE FROM " . DB_PREFIX . "product_image WHERE product_id = '" . (int)$product_id . "'");]]></search>
                <add position="before"><![CDATA[
                $this->db->query("DELETE FROM " . DB_PREFIX . "product_video WHERE product_id = '" . (int)$product_id . "'");
                ]]></add>
            </operation>
            <operation>
                <search><![CDATA[public function getProductImages($product_id) {]]></search>
                <add position="before"><![CDATA[
                public function getProductVideos($product_id) {
                    $query = $this->db->query("SELECT * FROM " . DB_PREFIX . "product_video WHERE product_id = '" . (int)$product_id . "' ORDER BY sort_order ASC");

                    return $query->rows;
                }
                ]]></add>
            </operation>
        </file>

        <!-- Вьюха -->
        <file path="admin/view/template/catalog/product_form.twig">
            <operation>
                <search><![CDATA[<li><a href="#tab-image" data-toggle="tab">{{ tab_image }}</a></li>]]></search>
                <add position="after"><![CDATA[
                {% if product_video_status %}<li><a href="#tab-video" data-toggle="tab">{{ tab_video }}</a></li>{% endif %}
                ]]></add>
            </operation>
            <operation>
                <search><![CDATA[
                <div class="tab-pane" id="tab-reward">
                ]]></search>
                <add position="before"><![CDATA[
                <div class="tab-pane" id="tab-video">
                  <div class="table-responsive">
                    <table id="videos" class="table table-striped table-bordered table-hover">
                      <thead>
                        <tr>
                          <td class="text-left">{{ entry_additional_video }}</td>
                          <td class="text-right">{{ entry_sort_order }}</td>
                          <td></td>
                        </tr>
                      </thead>
                      <tbody>
                        {% set video_row = 0 %}
                        {% for product_video in product_videos %}
                          <tr id="video-row{{ video_row }}">
                            <td class="text-left"><input type="text" name="product_video[{{ video_row }}][video]" value="{{ product_video.video }}" placeholder="{{ entry_video }}" class="form-control"/></td>
                            <td class="text-right"><input type="text" name="product_video[{{ video_row }}][sort_order]" value="{{ product_video.sort_order }}" placeholder="{{ entry_sort_order }}" class="form-control"/></td>
                            <td class="text-left"><button type="button" onclick="$('#video-row{{ video_row }}').remove();" data-toggle="tooltip" title="{{ button_remove }}" class="btn btn-danger"><i class="fa fa-minus-circle"></i></button></td>
                          </tr>
                          {% set video_row = video_row + 1 %}
                        {% endfor %}
                      </tbody>

                      <tfoot>
                        <tr>
                          <td colspan="2"></td>
                          <td class="text-left"><button type="button" onclick="addVideo();" data-toggle="tooltip" title="{{ button_video_add }}" class="btn btn-primary"><i class="fa fa-plus-circle"></i></button></td>
                        </tr>
                      </tfoot>
                    </table>
                  </div>
                </div>
                ]]></add>
            </operation>
            <operation>
                <search><![CDATA[
                    {{ footer }}
                ]]></search>
                <add position="before"><![CDATA[
                <script type="text/javascript"><!--
                  var video_row = {{ video_row }};

                  function addVideo() {
                      html = '<tr id="video-row' + video_row + '">';
                      html += '  <td class="text-left"><input type="text" name="product_video[' + video_row + '][video]" value="" placeholder="{{ entry_video }}" class="form-control" /></td>';
                      html += '  <td class="text-right"><input type="text" name="product_video[' + video_row + '][sort_order]" value="" placeholder="{{ entry_sort_order }}" class="form-control" /></td>';
                      html += '  <td class="text-left"><button type="button" onclick="$(\'#video-row' + video_row + '\').remove();" data-toggle="tooltip" title="{{ button_remove }}" class="btn btn-danger"><i class="fa fa-minus-circle"></i></button></td>';
                      html += '</tr>';

                      $('#videos tbody').append(html);

                      video_row++;
                  }

                  //--></script>
                ]]></add>
            </operation>
        </file>

    <!-- Front -->

        <!-- Переводы -->
        <file path="catalog/language/en-gb/product/product.php">
            <operation>
                <search><![CDATA[// dc_Translates]]></search>
                <add position="after"><![CDATA[
                $_['tab_video'] = 'Video';
                $_['text_video_tab'] = 'Video for';
                ]]></add>
            </operation>
        </file>
        <file path="catalog/language/ru-ru/product/product.php">
            <operation>
                <search><![CDATA[// dc_Translates]]></search>
                <add position="after"><![CDATA[
                $_['tab_video'] = 'Видео';
                $_['text_video_tab'] = 'Видео к';
                ]]></add>
            </operation>
        </file>
        <file path="catalog/language/uk-ua/product/product.php">
            <operation>
                <search><![CDATA[// dc_Translates]]></search>
                <add position="after"><![CDATA[
                $_['tab_video'] = 'Відео';
                $_['text_video_tab'] = 'Відео до';
                ]]></add>
            </operation>
        </file>

        <!-- Контроллер -->
        <file path="catalog/controller/product/product.php">
            <operation>
                <search><![CDATA[$data['column_left'] = $this->load->controller('common/column_left');]]></search>
                <add position="before"><![CDATA[
                $data['video_status'] = $this->config->get('theme_' . $this->config->get('config_theme') . '_product_video_status');
                $data['video_tab'] = $this->config->get('theme_' . $this->config->get('config_theme') . '_product_video_tab');
                $data['video_additional'] = $this->config->get('theme_' . $this->config->get('config_theme') . '_product_video_additional');
                $data['poster_size_w'] = $this->config->get('theme_' . $this->config->get('config_theme') . '_image_thumb_width');
                $data['poster_size_h'] = $this->config->get('theme_' . $this->config->get('config_theme') . '_image_thumb_height');
                $data['poster_additional_size_w'] = $this->config->get('theme_' . $this->config->get('config_theme') . '_image_additional_width');
                $data['poster_additional_size_h'] = $this->config->get('theme_' . $this->config->get('config_theme') . '_image_additional_height');
                if($data['video_tab'] == 1 && $data['video_additional']) {
                    $this->document->addScript('catalog/view/javascript/jquery.embedVideo.min.js');
                }

                $data['video_total'] = $this->model_catalog_product->getTotalVideos($product_info['product_id']);

                $data['videos'] = array();

                $results = $this->model_catalog_product->getProductVideos($this->request->get['product_id']);

                foreach ($results as $result) {
                    $data['videos'][] = array(
                        'video' => $result['video'],
                    );
                }
                ]]></add>
            </operation>
        </file>

        <!-- Модель -->
        <file path="catalog/model/catalog/product.php">
            <operation>
                <search><![CDATA[public function getProductImages($product_id) {]]></search>
                <add position="before"><![CDATA[
                public function getProductVideos($product_id) {
                    $query = $this->db->query("SELECT * FROM " . DB_PREFIX . "product_video WHERE product_id = '" . (int)$product_id . "' ORDER BY sort_order ASC");

                    return $query->rows;
                }
                public function getTotalVideos($product_id) {
                    $query = $this->db->query("SELECT COUNT(*) as total FROM " . DB_PREFIX . "product_video WHERE product_id = '" . (int)$product_id . "'");

                    return $query->row['total'];
                }
                ]]></add>
            </operation>
        </file>


</modification>